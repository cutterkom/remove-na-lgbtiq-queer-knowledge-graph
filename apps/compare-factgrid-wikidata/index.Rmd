---
title: "Compare Factgrid and Wikidata"
output: 
  flexdashboard::flex_dashboard:
    #orientation: rows
    vertical_layout: scroll
runtime: shiny
---


```{r setup, include=FALSE}
library(tidyverse)
library(glue)
library(SPARQL)
library(kabrutils)
library(here)
library(flexdashboard)
library(shinyFeedback)

endpoint <- "https://database.factgrid.de/sparql"

shinyFeedback::useShinyFeedback()
```


```{r fetch_available_properties}

#' Get properties related to persons
#' @return dataframe
get_person_properties <- function() {
  tmp <- readr::read_file("https://raw.githubusercontent.com/cutterkom/remove-na-lgbtiq-queer-knowledge-graph/main/data-publishing/factgrid/queries/get_all_properties_person_with_corresponding_prop.rq") %>% 
  sparql_to_tibble(endpoint = endpoint) %>%
  mutate(
    fg_property_id = str_extract(fg_property, "P[0-9]+"),
    wd_property_id = str_extract(wd_property, "P[0-9]+"),
    label = paste0(fg_propertyLabel, " (FG: ", fg_property_id, ", WD: ", wd_property_id, ")"),
    label = str_remove_all(label, '"|@en')
    ) 
    
  return(tmp)
}
```


Inputs {.sidebar}
=====================================

Which property should be compared?

```{r get_properties}
persons_properties <- get_person_properties() %>% arrange(fg_propertyLabel)

persons_properties_list  <- persons_properties %>% 
  select(label, fg_property_id) %>% 
  deframe()

checkboxGroupInput("person_properties", label = "Properties available that refer to persons", choices = persons_properties_list)

textInput("item_filter", label = "Filter items", placeholder = "?fg_item fgt:P131 fg:Q400012")

actionButton("button_start_person_properties", "Submit", class = "btn-primary")
```

Please be patient, it may take a few moments if a lot of data is requested... 

```{r get_comparison_fun}

#' Get comparison data based on property
#' 
#' This functions queries data on Factgrid looking for properties related to persons that have a corresponding Wikidata property. Utilizes federated queries.
#' @param input_properties chosen properties in input$person_properties
#' @param input_items_filter filter items e.g. like ?fg_item fgt:P131 fg:Q400012 . (don't forget the period!)
#' @return dataframe
get_comparison <- function(input_properties, input_items_filter) {
  persons_properties %>% 
    filter(fg_property_id %in% input_properties) %>% 
    pmap_dfr(function(...) {
      current <- tibble(...)
      cli::cli_alert_info("Fetch data for: {current$fg_propertyLabel}")
      fg_property_id <- current$fg_property_id
      
      query <- paste0( '
      #defaultView:Table
      
      # Prefix standard 
      # Factgrid
      PREFIX fg: <https://database.factgrid.de/entity/>
      PREFIX fgt: <https://database.factgrid.de/prop/direct/>
      
      # Wikidata
      PREFIX wdt: <http://www.wikidata.org/prop/direct/>
      PREFIX wd: <http://www.wikidata.org/entity/>
      # misc
      PREFIX wikibase: <http://wikiba.se/ontology#>
      PREFIX bd: <http://www.bigdata.com/rdf#>
      PREFIX schema: <http://schema.org/>
      
      SELECT DISTINCT ?fg_item ?fg_itemLabel ?wd_item ?fg_property ?fg_propertyLabel ?wd_property ?fg_value ?fg_valueLabel ?wd_value_from_fg ?wd_value_from_wd ?fg_value_from_wd ?is_same where {
      
        # labels from Factgrid
        SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }  
      
      ',
      input_items_filter
      ,'
      
        # which property in focus?
        BIND(fgt:', fg_property_id, ' as ?fg_property)
        BIND(fg:', fg_property_id, ' as ?fg_property_as_item)
        # set property of corresponding wikidata property; is constant
        BIND(fgt:P343 as ?fg_corr_wd)
      
        # transform wikidata qid in factgrid to wikidata entity iri
        ?link schema:about ?fg_item .
        ?link schema:isPartOf <https://www.wikidata.org/> . 
        ?link schema:name ?qid.
        BIND(IRI(CONCAT(STR(wd:), ?qid)) AS ?wd_item)
      
        # get corresponding wikidata property
        # and store as IRI
        ?fg_property_as_item ?fg_corr_wd ?fg_corr_wd_value .
        BIND(IRI(CONCAT(STR(wdt:), ?fg_corr_wd_value)) AS ?wd_property)
      
        # get factgrid statement
        ?fg_item ?fg_property ?fg_value .
        # get wikidata qid of fg_value
        # used later for comparison
        ?link_value schema:about ?fg_value .
        ?link_value schema:isPartOf <https://www.wikidata.org/> . 
        ?link_value schema:name ?qid_value.
        BIND(IRI(CONCAT(STR(wd:), ?qid_value)) AS ?wd_value_from_fg)
      
        # now change to wikidata as data source
        # get value from wikidata
        SERVICE <https://query.wikidata.org/sparql> {
            OPTIONAL {
                ?wd_item ?wd_property ?wd_value_from_wd.
              OPTIONAL {
                ?wd_value_from_wd wdt:P8168 ?fg_value_from_wd.
              }
            }

        }
        BIND (IF(?wd_value_from_fg = ?wd_value_from_wd, "true", "false") AS ?is_same)
      }
      
      ')
      
      print(query)
      
      res <- sparql_to_tibble(query, endpoint = endpoint) 
      print(res)
       if(nrow(res) > 0) {
        res <- res %>% 
          mutate(
            fg_property_id = str_extract(fg_property, "P[0-9]+"),
            wd_property_id = str_extract(wd_property, "P[0-9]+"))
       } else {
        res <- tibble(
          fg_item = NA_character_,
          fg_itemLabel = NA_character_,
          wd_item = NA_character_,
          fg_property = NA_character_,
          fg_propertyLabel = NA_character_,
          wd_property = NA_character_,
          fg_value = NA_character_,
          fg_valueLabel = NA_character_,
          wd_value_from_fg = NA_character_,
          wd_value_from_wd = NA_character_,
          is_same = NA_character_,
          fg_property_id = NA_character_,
          wd_property_id = NA_character_
        )
       }
      cli::cli_alert_success("data fetched")
     res
    })
}

```

```{r create_link_fun}

#' Function that creates a link from href and string
#' @param data dataframe with cols
#' @param url href for link
#' @param name string for inside <a href>name</a>
#' @param new_col name of new col
create_link <- function(data, url, name, new_col) {
  data %>% 
    mutate(
      {{new_col}} := str_replace({{url}}, "<", "<a href='"),
      {{new_col}} := str_replace({{new_col}}, ">", "' target='_blank'>"),
      {{new_col}} := paste0({{new_col}}, {{name}}, "</a>")
    )
}
```

```{r get_import_data}
#' Create data for Quickstatements import
#' @param data if only_in_wd or only_in_fg
#' @param target if import into wikidata or factgrid
#' @return dataframe
get_import_data <- function(data, target) {

  if (target == "wikidata") {
    import_data <- comparison_raw() %>% 
      inner_join(data %>% distinct(fg_item, wd_value_from_fg), by = c("fg_item", "wd_value_from_fg")) %>% 
      mutate(
        fg_item_id = str_extract(fg_item, "Q[0-9]+"),
        fg_value_id = str_extract(fg_value, "Q[0-9]+"),
        wd_item_id = str_extract(wd_item, "Q[0-9]+"),
        wd_value_from_fg_id = str_extract(wd_value_from_fg, "Q[0-9]+"),
        fg_value_from_wd_id = str_extract(fg_value_from_wd, "Q[0-9]+"),
        fg_value_id = paste0('"', fg_value_id, '"')) %>% 
        # add source of Factgrid-Object
        bind_cols(tibble(source = "S8168", time = "S813", timestamp = paste0("+", Sys.Date(), "T00:00:00Z/", 11))) %>% 
        select(item = wd_item_id, property = wd_property_id, value = wd_value_from_fg_id, 
               source, source_value = fg_value_id, 
               time, timestamp) %>% 
        distinct()
    
    cli::cli_alert_success("data copied for import in wikidata")
    
    import_data
  } else if (target == "factgrid") {
    import_data <- comparison_raw() %>% 
      inner_join(data %>% distinct(fg_item, wd_value_from_wd), by = c("fg_item", "wd_value_from_wd")) %>%
      mutate(
        # item: FG item
        fg_item_id = str_extract(fg_item, "Q[0-9]+"),
        # FG value derived from Wikidata
        fg_value_from_wd_id = str_extract(fg_value_from_wd, "Q[0-9]+"),
        # Wikidata value for source
        wd_value_from_wd = str_extract(wd_value_from_fg, "Q[0-9]+")) %>% 
    
        #fg_value_id = #paste0('"', fg_value_id, '"')) %>% View
      # add source of Factgrid-Object
      bind_cols(tibble(source = "S771", time = "S432", timestamp = paste0("+", Sys.Date(), "T00:00:00Z/", 11))) %>% 
      select(item = fg_item_id, property = fg_property_id, value = fg_value_from_wd_id, 
             source, source_value = wd_value_from_wd, 
             time, timestamp) %>% 
      # can only import those with a Factgrid ID in Wikidata
      filter(!is.na(value)) %>% 
      distinct()
    cli::cli_alert_success("data copied for import in factgrid")
    import_data

  } else {
    stop("no valid target. Only `wikidata` or `factgrid` allowed")
  }
}
```


```{r fetch_data}
comparison_raw <- eventReactive(input$button_start_person_properties, {
  
  if(is.null(input$person_properties)) {
        shinyFeedback::showToast(
      "error", 
      "You have to select at least one property"
    )
  } else {

    data <- get_comparison(input$person_properties, input$item_filter)
    
    shinyFeedback::showToast(
      "success", 
      "data loaded"
    )
    data
  }
  })
```

Refering to Persons
=====================================  

Properties you asked for:  {data-height=70, data-width=70}
-------------------------------------

### in both {.value-box}

```{r}
in_both_nrow <- reactive({
  nrow(in_both() %>% 
     distinct())
})

renderValueBox({
  valueBox(
    value = in_both_nrow(),
    icon = "fa-area-chart"
  )
})
```

### only in Factgrid {.value-box}

```{r}
only_in_fg_nrow <- reactive({
  nrow(only_in_fg() %>% 
     distinct())
})

renderValueBox({
  valueBox(
    value = only_in_fg_nrow(),
    icon = "fa-area-chart"
  )
})
```

### only in Wikidata {.value-box}

```{r}
only_in_wd_nrow <- reactive({
  nrow(only_in_wd() %>% 
         distinct(fg_item, wd_value_from_wd))
})

renderValueBox({
  valueBox(
    value = only_in_wd_nrow(),
    icon = "fa-area-chart"
  )
})
```


Row {.tabset .tabset-fade}
-------------------------------------
   
### Both, in Factgrid and Wikidata

#### Table
```{r filter_in_both}
in_both <- reactive({
  data <- comparison_raw() %>% 
    filter(is_same == "true") %>% 
    distinct(fg_item, fg_itemLabel, wd_item, fg_property_id, fg_value, fg_valueLabel, wd_value_from_fg, wd_value_from_wd) %>% 
    # add property info
    left_join(persons_properties %>% select(fg_property_id, fg_propertyLabel, fg_property, wd_property), by = "fg_property_id")
})
```

```{r show_table_in_both}
DT::renderDataTable(
  DT::datatable(

  in_both() %>% 
    # link for items
    create_link(url = fg_item, name = "Factgrid", new_col = fg_item_link) %>% 
    create_link(url = wd_item, name = "Wikidata", new_col = wd_item_link) %>% 
    mutate(item = paste0(fg_itemLabel, " (", fg_item_link, ", ", wd_item_link, ")")) %>% 
    # links for properties
    create_link(url = fg_property, name = "Factgrid", new_col = fg_property_link) %>% 
    create_link(url = wd_property, name = "Wikidata", new_col = wd_property_link) %>% 
    mutate(property = paste0(fg_propertyLabel, " (", fg_property_link, ", ", wd_property_link, ")")) %>% 
    
    # links for values
    create_link(url = fg_value, name = "Factgrid", new_col = fg_value_link) %>% 
    create_link(url = wd_value_from_fg, name = "Wikidata", new_col = wd_value_link) %>% 
    mutate(value = paste0(fg_valueLabel, " (", fg_value_link, ", ", wd_value_link, ")")) %>% 
    
    # get relevant columns
    select(item, property, value) %>% 
     distinct(),
  escape = FALSE) # show link as link
)
```

### Only in Factgrid

```{r filter_only_in_fg}
only_in_fg <- reactive({
  
  data <- comparison_raw() %>% 
    filter(is.na(is_same), !is.na(fg_item)) %>% 
    distinct(fg_item, fg_itemLabel, wd_item, fg_property_id, fg_value, fg_valueLabel, wd_value_from_fg, wd_value_from_wd) %>% 
    # remove those that are present in wd
    anti_join(in_both(), by = c("fg_item", "wd_value_from_fg")) %>% 
    # add property info
    left_join(persons_properties %>% select(fg_property_id, fg_propertyLabel, fg_property, wd_property), by = "fg_property_id")
  
  })
```

#### Table
```{r show_table_only_in_fg}
DT::renderDataTable(
  DT::datatable(
  only_in_fg() %>% 
    # link for items
    create_link(url = fg_item, name = "Factgrid", new_col = fg_item_link) %>% 
    create_link(url = wd_item, name = "Wikidata", new_col = wd_item_link) %>% 
    mutate(item = paste0(fg_itemLabel, " (", fg_item_link, ", ", wd_item_link, ")")) %>% 
    # links for properties
    create_link(url = fg_property, name = "Factgrid", new_col = fg_property_link) %>% 
    create_link(url = wd_property, name = "Wikidata", new_col = wd_property_link) %>% 
    mutate(property = paste0(fg_propertyLabel, " (", fg_property_link, ", ", wd_property_link, ")")) %>% 
    
    # links for values
    create_link(url = fg_value, name = "Factgrid", new_col = fg_value_link) %>% 
    create_link(url = wd_value_from_fg, name = "Wikidata", new_col = wd_value_link) %>% 
    mutate(value = paste0(fg_valueLabel, " (", fg_value_link, ", ", wd_value_link, ")")) %>% 
    
    # get relevant columns
    select(item, property, value) %>% 
     distinct(),
  escape = FALSE)
)

```

#### Import to Wikidata
This data can be imported to Wikidata. Click the button and paste it into [Wikidata's Quickstatements Tool](https://quickstatements.toolforge.org/#/).
```{r}
uiOutput("download_wikidata_import_UI")

import_in_wikidata <- reactive({
  data <- get_import_data(only_in_fg(), target = "wikidata") %>% 
     distinct()
  data
})

# create download button
output$download_wikidata_import_UI <- renderUI( {
  downloadButton("download_wikidata_import", "Download data for Wikidata import", class = "btn-primary")
})

# Add download handling
output$download_wikidata_import <- downloadHandler(
  filename = function() {
    "import_wikidata.csv"
  },
  content = function(file) {
    write.csv(import_in_wikidata(), file, row.names = FALSE)
  }
)
```

### Only in Wikidata

```{r filter_only_in_wd}
only_in_wd <- reactive({
  
  data <- comparison_raw() %>% 
    filter(is_same == "false") %>% 
    distinct(fg_item, fg_itemLabel, wd_item, fg_property_id, wd_value_from_wd, fg_value_from_wd) %>% 
    # remove those that are present in wd
    anti_join(in_both(), by = c("fg_item", "wd_value_from_wd")) %>%
    # add property info
    left_join(persons_properties %>% select(fg_property_id, fg_propertyLabel, fg_property, wd_property), by = "fg_property_id")
  
  })

```

#### Table

Labels from Wikidata are not shown (yet), because it would takes quite a time. 
```{r show_table_only_in_wd}
DT::renderDataTable(
  DT::datatable(
    only_in_wd() %>% 
     # link for items
      create_link(url = fg_item, name = "Factgrid", new_col = fg_item_link) %>% 
      create_link(url = wd_item, name = "Wikidata", new_col = wd_item_link) %>% 
      mutate(item = paste0(fg_itemLabel, " (", fg_item_link, ", ", wd_item_link, ")")) %>% 
      
      # links for properties
      create_link(url = fg_property, name = "Factgrid", new_col = fg_property_link) %>% 
      create_link(url = wd_property, name = "Wikidata", new_col = wd_property_link) %>% 
      mutate(property = paste0(fg_propertyLabel, " (", fg_property_link, ", ", wd_property_link, ")")) %>% 
      
      # links for values
      # no label, needs to be fetched from wikidata
      create_link(new_col = wd_value_link, url = wd_value_from_wd, name = "Wikidata") %>% 
      mutate(
        fg_value_from_wd_link = paste0('<a href="https://database.factgrid.de/wiki/Item:', fg_value_from_wd, '">Factgrid</a>'),
        value = 
               case_when(
                 !is.na(fg_value_from_wd) ~ paste0(" (", fg_value_from_wd_link, ", ", wd_value_link, ")"),
                 TRUE ~ paste0(wd_value_link)
                 )
        ) %>% 
      
      # get relevant columns
      select(item, property, value) %>% 
       distinct(),
  escape = FALSE)
)

```

#### Import to Factgrid
This data can be imported to Factgrid. Click the button and paste it into [Factgrid's Quickstatements Tool](https://database.factgrid.de/quickstatements/#/). Only those can be imported, that have a Factgrid-ID in Wikidata.
```{r}
uiOutput("download_factgrid_import_UI")

import_in_factgrid <- reactive({
  data <- get_import_data(only_in_wd(), target = "factgrid") %>% 
    filter(!is.na(value)) %>% 
    distinct()
})

# create download button
output$download_factgrid_import_UI <- renderUI( {
  downloadButton("download_factgrid_import", "Download data for Factgrid import", class = "btn-primary")
})

# Add download handling
output$download_factgrid_import <- downloadHandler(
  filename = function() {
    "import_factgrid.csv"
  },
  content = function(file) {
    write.csv(import_in_factgrid(), file, row.names = FALSE)
  }
)
```